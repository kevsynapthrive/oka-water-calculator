<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oka' Institute Water Pricing Calculator Tool</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/collapsible-tables.css" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’§</text></svg>"
      type="image/svg+xml"
    />
  </head>
  <body>
    <header class="app-header bg-primary text-white py-2 sticky-top shadow-sm">
      <div class="container-fluid">
        <div class="d-flex flex-wrap align-items-center">
          <!-- Logo and Title Section -->
          <div class="d-flex align-items-center me-auto">
            <img
              src="OkaLogo.png"
              alt="Oka' Institute Logo"
              class="img-fluid me-3"
              style="height: 55px"
              onerror="this.onerror=null; this.src='https://placehold.co/55x55/007bff/ffffff?text=Logo';"
            />
            <div>
              <h1 class="fs-4 mb-0 d-flex align-items-center">
                Oka' Institute Water Pricing Calculator
                <span class="badge bg-light text-primary ms-2 fs-6">v1.0</span>
              </h1>
              <p class="small mb-0 text-white-50">
                Plan sustainable, long-term water rates for your rural community
              </p>
            </div>
          </div>
    
          <!-- Scenario Selector - Only on larger screens -->
          <div class="d-none d-lg-flex align-items-center me-3">
            <label for="scenarioSelect" class="form-label text-white-50 me-2 mb-0 small">
              Load Sample:
            </label>
            <select class="form-select form-select-sm" id="scenarioSelect" style="min-width: 200px;">
              <option value="">-- Select a scenario --</option>
              <option value="madill">Madill, OK (&lt; 4,000)</option>
              <option value="tuttle">Tuttle, OK (~ 8,000)</option>
              <option value="newcastle">Newcastle, OK (~ 10,000)</option>
              <option value="ardmore">Ardmore, OK (~ 25,000)</option>
            </select>
          </div>
    
          <!-- Navigation and Action Buttons -->
          <div class="d-flex align-items-center gap-2">
            <!-- Main Navigation - Hidden on mobile -->
            <div class="d-none d-md-flex gap-2 me-2">
              <a class="btn btn-sm btn-outline-light" href="#inputs-section">
                <i class="bi bi-input-cursor"></i>
                <span class="d-none d-lg-inline ms-1">Inputs</span>
              </a>
              <a class="btn btn-sm btn-outline-light" href="#results-section">
                <i class="bi bi-graph-up"></i>
                <span class="d-none d-lg-inline ms-1">Results</span>
              </a>
              <a class="btn btn-sm btn-outline-light" href="#financialAdvisorContainer">
                <i class="bi bi-graph-up-arrow"></i>
                <span class="d-none d-lg-inline ms-1">Advisor</span>
              </a>
            </div>
    
            <!-- Action Buttons -->
            <button
              id="collapseAll"
              class="btn btn-outline-light btn-sm"
              data-expanded="true"
              title="Collapse or expand all input sections"
            >
              <i class="bi bi-arrows-collapse"></i>
              <span class="d-none d-xl-inline ms-1">Collapse</span>
            </button>
    
            <div class="btn-group btn-group-sm">
              <button
                id="exportBtn"
                class="btn btn-outline-light"
                title="Export all data to CSV"
              >
                <i class="bi bi-download"></i>
                <span class="d-none d-xl-inline ms-1">Export</span>
              </button>
              <button
                id="importBtn"
                class="btn btn-outline-light"
                title="Import data from CSV"
              >
                <i class="bi bi-upload"></i>
                <span class="d-none d-xl-inline ms-1">Import</span>
              </button>
              <input type="file" id="fileInput" accept=".csv" style="display: none" />
            </div>
    
            <button
              id="showMathButton"
              class="btn btn-outline-light btn-sm"
              title="Show or hide calculation details"
            >
              <i class="bi bi-calculator"></i>
              <span class="d-none d-xl-inline ms-1">Math</span>
            </button>
    
            <button
              id="helpButton"
              class="btn btn-sm btn-light"
              title="Help and information"
              data-bs-toggle="modal"
              data-bs-target="#helpModal"
            >
              <i class="bi bi-question-circle text-primary"></i>
            </button>
          </div>
        </div>
    
        <!-- Mobile Navigation Row -->
        <div class="d-md-none mt-2">
          <div class="row g-2">
            <!-- Mobile Navigation -->
            <div class="col-12 mb-2">
              <div class="btn-group btn-group-sm w-100">
                <a class="btn btn-outline-light" href="#inputs-section">
                  <i class="bi bi-input-cursor"></i> Inputs
                </a>
                <a class="btn btn-outline-light" href="#results-section">
                  <i class="bi bi-graph-up"></i> Results
                </a>
                <a class="btn btn-outline-light" href="#financialAdvisorContainer">
                  <i class="bi bi-graph-up-arrow"></i> Advisor
                </a>
              </div>
            </div>
            
            <!-- Mobile Scenario Selector -->
            <div class="col-12">
              <select class="form-select form-select-sm" id="scenarioSelectMobile">
                <option value="">Load Sample Scenario...</option>
                <option value="madill">Madill, OK (&lt; 4,000)</option>
                <option value="tuttle">Tuttle, OK (~ 8,000)</option>
                <option value="newcastle">Newcastle, OK (~ 10,000)</option>
                <option value="ardmore">Ardmore, OK (~ 25,000)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="container-fluid">
            <div class="alert bg-danger text-white m-0" role="alert" style="border-radius: 0;">
        <div class="container-fluid">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-3 me-3 text-warning"></i>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-1 text-danger-emphasis">DEVELOPMENT VERSION</h5>
              <p class="mb-0"><strong>This tool is currently under active development.</strong> The interface, functionality, and mathematical calculations are being tested and validated by financial experts. </p><p>Results should not be used for official planning purposes at this time.</p>
            </div>
            <div class="d-none d-md-block">
            <i class="bi bi-exclamation-triangle-fill fs-3 me-3 text-warning"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid" id="inputs-section">
        <div class="">
          <div
            class="bg-light p-3 d-flex justify-content-between align-items-center border-bottom"
          >
            <h3 class="mb-0">
              <!-- Change mb-3 to mb-0 -->
              <i class="bi bi-sliders2-vertical me-2"></i>Input Parameters
            </h3>
          </div>
          <div class="card-body p-0">
            <!-- Community Information Card -->
            <div class="">
              <div class="card mb-2">
                <div
                  class="card-header bg-light d-flex justify-content-between align-items-center"
                  data-bs-toggle="collapse"
                  data-bs-target="#communityCollapse"
                  aria-expanded="true"
                >
                  <h3 class="card-title mb-0">
                    <i class="bi bi-people me-2"></i>Community Information
                  </h3>
                  <i class="bi bi-chevron-down toggle-icon"></i>
                </div>
                <div class="collapse show" id="communityCollapse">
                  <div class="card-body">
                    <!-- Basic Community Info -->
                    <h5 class="text-primary mb-3">Basic Information</h5>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="communityName" class="form-label"
                            >Community Name</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="communityName"
                            placeholder="Enter community name"
                          />
                        </div>
                        <div class="mb-3">
                          <label for="customerCount" class="form-label"
                            >Number of Water Service Accounts</label
                          >
                          <input
                            type="number"
                            class="form-control"
                            id="customerCount"
                            placeholder="0"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="avgMonthlyUsage" class="form-label"
                            >Average Monthly Usage per Customer (gallons)</label
                          >
                          <input
                            type="number"
                            class="form-control"
                            id="avgMonthlyUsage"
                            placeholder="0"
                          />
                        </div>
                        <div class="mb-3">
                          <label for="waterLossSlider" class="form-label"
                            >Water Loss Percentage:
                            <span id="waterLossValue">0</span>%</label
                          >
                          <input
                            type="range"
                            class="form-range"
                            id="waterLossSlider"
                            min="0"
                            max="50"
                            step="1"
                            value="0"
                          />
                          <div
                            class="d-flex justify-content-between small text-muted mt-1"
                          >
                            <span>0%</span><span>50%</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr class="my-4" />

                    <!-- Economic Demographics -->
                    <h5 class="text-primary mb-3">Economic Demographics</h5>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="medianIncome" class="form-label"
                            >Median Household Income ($)</label
                          >
                          <input
                            type="number"
                            class="form-control"
                            id="medianIncome"
                            placeholder="0"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="povertyIncome" class="form-label"
                            >Poverty Level Income Threshold ($)</label
                          >
                          <input
                            type="number"
                            class="form-control"
                            id="povertyIncome"
                            placeholder="0"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="belowPovertySlider" class="form-label"
                            >Percentage of Households Below Poverty Level:
                            <span id="belowPovertyValue">0</span>%</label
                          >
                          <input
                            type="range"
                            class="form-range"
                            id="belowPovertySlider"
                            min="0"
                            max="100"
                            step="1"
                            value="0"
                          />
                          <div
                            class="d-flex justify-content-between small text-muted mt-1"
                          >
                            <span>0%</span><span>100%</span>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <small class="text-muted">
                          <strong>Note:</strong> Economic data helps calculate
                          affordability impacts and ensures rate recommendations
                          consider community demographics.
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Financial Information Card -->
            <div class="card mb-2">
              <div
                class="card-header bg-light d-flex justify-content-between align-items-center"
                data-bs-toggle="collapse"
                data-bs-target="#financialCollapse"
                aria-expanded="true"
              >
                <h3 class="card-title mb-0">
                  <i class="bi bi-currency-dollar me-2"></i>Financial
                  Information
                </h3>
                <i class="bi bi-chevron-down toggle-icon"></i>
              </div>
              <div class="collapse show" id="financialCollapse">
                <div class="card-body">
                  <!-- Current Financial Status -->
                  <h5 class="text-primary mb-3">Current Financial Status</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="operatingCost" class="form-label"
                          >Annual Operating & Maintenance Costs ($)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="operatingCost"
                          placeholder="0"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="debtPayments" class="form-label"
                          >Current Annual Debt Payments ($)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="debtPayments"
                          min="0"
                          value="0"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="debtTerm" class="form-label"
                          >Remaining Years on Existing Debt</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="debtTerm"
                          min="0"
                          value="20"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="projectionPeriod" class="form-label"
                          >Analysis Period (years)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="projectionPeriod"
                          placeholder="0"
                        />
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />

                  <!-- Infrastructure Planning -->
                  <h5 class="text-primary mb-3">Infrastructure Planning</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="infrastructureCost" class="form-label"
                          >Estimated Total Infrastructure Replacement Cost
                          ($)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="infrastructureCost"
                          placeholder="0"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="assetLifespanSlider" class="form-label"
                          >Average Asset Lifespan (Years):
                          <span id="assetLifespanValue">0</span></label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="assetLifespanSlider"
                          min="0"
                          max="100"
                          step="1"
                          value="0"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="targetReserve" class="form-label"
                          >Target Reserve Fund Amount ($)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          id="targetReserve"
                          placeholder="0"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="targetYearSlider" class="form-label"
                          >Years to Achieve Reserve Target:
                          <span id="targetYearValue">0</span></label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="targetYearSlider"
                          min="1"
                          max="50"
                          step="1"
                          value="0"
                        />
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />

                  <!-- Economic Assumptions -->
                  <h5 class="text-primary mb-3">Economic Assumptions</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="inflationRateSlider" class="form-label"
                          >Annual O&M Cost Inflation Rate:
                          <span id="inflationRateValue">0</span>%</label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="inflationRateSlider"
                          min="0"
                          max="10"
                          step="0.1"
                          value="0"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="interestRateSlider" class="form-label"
                          >Interest Rate for Reserve Fund Investments:
                          <span id="interestRateValue">0</span>%</label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="interestRateSlider"
                          min="0"
                          max="10"
                          step="0.1"
                          value="0"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="customerGrowthSlider" class="form-label"
                          >Annual Customer Growth Rate:
                          <span id="customerGrowthValue">0</span>%</label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="customerGrowthSlider"
                          min="0"
                          max="10"
                          step="0.1"
                          value="0"
                        />
                      </div>
                      <div class="mb-3">
                        <label for="interestAdjustmentSlider" class="form-label"
                          >Annual Interest Rate Change:
                          <span id="interestAdjustmentValue">0</span>%</label
                        >
                        <input
                          type="range"
                          class="form-range"
                          id="interestAdjustmentSlider"
                          min="-2"
                          max="2"
                          step="0.1"
                          value="0"
                        />
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />

                  <!-- Analysis Options -->
                  <h5 class="text-primary mb-3">Analysis Options</h5>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="includeReserveCheckbox"
                          checked
                          title="When checked, infrastructure reserve contributions are included in required revenue needs. Unchecking will show a more achievable short-term revenue target."
                        />
                        <label
                          class="form-check-label"
                          for="includeReserveCheckbox"
                        >
                          Include infrastructure reserve fund contributions in
                          What-If revenue needs calculations
                        </label>
                        <small class="form-text text-muted d-block">
                          Uncheck this to see short-term revenue targets without
                          long-term infrastructure funding requirements.
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Financial Planning Card -->
            <div class="card mb-2">
              <div
                class="card-header bg-light d-flex justify-content-between align-items-center"
                data-bs-toggle="collapse"
                data-bs-target="#financialPlanningCollapse"
                aria-expanded="true"
              >
                <h3 class="card-title mb-0">
                  <i class="bi bi-calendar-check me-2"></i>Financial Planning
                </h3>
                <i class="bi bi-chevron-down toggle-icon"></i>
              </div>
              <div class="collapse show" id="financialPlanningCollapse">
                <div class="card-body">
                  <!-- Overview Help -->
                  <div
                    class="alert alert-info alert-dismissible fade show mb-4"
                  >
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="alert"
                    ></button>
                    <h5>
                      <i class="bi bi-info-circle"></i> Financial Planning
                      Overview
                    </h5>
                    <p class="mb-2">
                      Use this section to plan your water system's financial
                      future by entering:
                    </p>
                    <ul class="mb-0">
                      <li>
                        <strong>Capital Projects:</strong> Infrastructure
                        investments and improvements
                      </li>
                      <li>
                        <strong>Loans & Debt:</strong> Existing and planned
                        borrowing
                      </li>
                      <li>
                        <strong>Grants & Funding:</strong> External financial
                        assistance
                      </li>
                    </ul>
                  </div>

                  <!-- Capital Projects Section -->
                  <div class="border rounded p-3 mb-4 bg-light">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5 class="text-primary mb-0">
                        <i class="bi bi-tools me-2"></i>Capital Projects &
                        Infrastructure
                      </h5>
                      <button id="addProject" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Project
                      </button>
                    </div>

                    <div
                      class="alert alert-info alert-dismissible fade show mb-3"
                      id="project-loan-help-alert"
                    >
                      <h6>
                        <i class="bi bi-lightbulb"></i> Project Financing Tips
                      </h6>
                      <ul class="mb-2 small">
                        <li>
                          <strong>Reserves:</strong> Use existing funds or build
                          reserves over time
                        </li>
                        <li>
                          <strong>Loan/Debt:</strong> Uses default terms (3%
                          interest, 20 years) unless customized in Loans section
                        </li>
                        <li>
                          <strong>Timing:</strong> Enter the year when the
                          project will begin
                        </li>
                      </ul>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="alert"
                      ></button>
                    </div>

                    <div id="projectsContainer">
                      <!-- Dynamic project entries will be added here by app.js -->
                      <!-- Template structure matches app.js addProjectEntry(): -->
                      <!-- 
                        - project-name (text)
                        - project-cost (number) 
                        - project-year (number)
                        - project-funding (select: reserves/loan)
                        -->
                    </div>
                  </div>

                  <!-- Loans and Debt Section -->
                  <div class="border rounded p-3 mb-4 bg-light">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5 class="text-primary mb-0">
                        <i class="bi bi-credit-card me-2"></i>Loans & Debt
                        Management
                      </h5>
                      <button id="addLoan" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Loan
                      </button>
                    </div>

                    <div
                      class="alert alert-warning alert-dismissible fade show mb-3"
                      id="debt-help-alert"
                    >
                      <h6>
                        <i class="bi bi-exclamation-triangle"></i> Avoiding
                        Double-Counted Debt
                      </h6>
                      <div class="row">
                        <div class="col-md-6">
                          <p class="small mb-1">
                            <strong>For existing loans:</strong>
                          </p>
                          <ul class="small mb-2">
                            <li>Add them in this Loans & Debt section</li>
                            <li>
                              Include general operating loans or past
                              infrastructure loans
                            </li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <p class="small mb-1">
                            <strong>For future project financing:</strong>
                          </p>
                          <ul class="small mb-2">
                            <li>
                              Either select "Loan/Debt" in the project above, OR
                            </li>
                            <li>
                              Add a loan here with the same name as your project
                            </li>
                          </ul>
                        </div>
                      </div>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="alert"
                      ></button>
                    </div>

                    <div id="loansContainer">
                      <!-- Dynamic loan entries will be added here by app.js -->
                      <!-- Template structure matches app.js addLoanEntry(): -->
                      <!-- 
                        - loan-name (text)
                        - loan-amount (number)
                        - loan-interest (number) 
                        - loan-term (number)
                        - loan-year (number)
                        -->
                    </div>
                  </div>

                  <!-- Grants and Funding Section -->
                  <div class="border rounded p-3 mb-4 bg-light">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5 class="text-primary mb-0">
                        <i class="bi bi-gift me-2"></i>Grants & External Funding
                      </h5>
                      <button id="addGrant" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Add Grant
                      </button>
                    </div>

                    <div
                      class="alert alert-success alert-dismissible fade show mb-3"
                    >
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="alert"
                      ></button>
                      <h6>
                        <i class="bi bi-lightbulb"></i> Grant Funding Tips
                      </h6>
                      <div class="row">
                        <div class="col-md-6">
                          <p class="small mb-1">
                            <strong>Common Sources:</strong>
                          </p>
                          <ul class="small mb-0">
                            <li>USDA Rural Development</li>
                            <li>EPA Water Infrastructure Finance</li>
                            <li>State revolving funds (SRF)</li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <p class="small mb-1">
                            <strong>Best Practices:</strong>
                          </p>
                          <ul class="small mb-0">
                            <li>
                              Include only confirmed or highly likely grants
                            </li>
                            <li>Enter the year funds will be received</li>
                            <li>Consider matching fund requirements</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div id="grantsContainer">
                      <!-- Dynamic grant entries will be added here by app.js -->
                      <!-- Template structure matches app.js addGrantEntry(): -->
                      <!-- 
                        - grant-name (text)
                        - grant-amount (number)
                        - grant-year (number)
                        -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rate Structures Row - Compatible Improved Layout -->
            <div class="row">
              <div class="col-lg-6">
                <!-- Current Rate Structure -->
                <div class="card mb-2">
                  <div
                    class="card-header bg-light d-flex justify-content-between align-items-center"
                    data-bs-toggle="collapse"
                    data-bs-target="#currentRateCollapse"
                    aria-expanded="true"
                  >
                    <h3 class="card-title">
                      <i class="bi bi-clock-history me-2"></i>Current Rate
                      Structure
                    </h3>
                    <i class="bi bi-chevron-down toggle-icon"></i>
                  </div>
                  <div class="collapse show" id="currentRateCollapse">
                    <div class="card-body">
                      <!-- Fixed Charges -->
                      <div class="bg-light p-3 rounded mb-4">
                        <h5 class="text-primary mb-3">
                          <i class="bi bi-currency-dollar me-2"></i>Fixed
                          Monthly Charges
                        </h5>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="currentBaseRate" class="form-label"
                                >Base Rate ($)</label
                              >
                              <input
                                type="number"
                                class="form-control"
                                id="currentBaseRate"
                                placeholder="0.00"
                                step="0.01"
                              />
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="currentAddonFee" class="form-label"
                                >Add-on Fee ($)</label
                              >
                              <input
                                type="number"
                                class="form-control"
                                id="currentAddonFee"
                                placeholder="0.00"
                                step="0.01"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Tier Structure -->
                      <h5 class="text-primary mb-3">
                        <i class="bi bi-bar-chart-steps me-2"></i>Tiered Usage
                        Rates
                      </h5>

                      <!-- Tier 1 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="currentTier1Enabled"
                                  checked
                                />
                                <label
                                  class="form-check-label fw-bold text-primary"
                                  for="currentTier1Enabled"
                                >
                                  Tier 1
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier1Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="currentTier1Limit"
                                  placeholder="5,000"
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier1Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="currentTier1Rate"
                                  placeholder="2.50"
                                  step="0.01"
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Tier 2 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="currentTier2Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-warning"
                                  for="currentTier2Enabled"
                                >
                                  Tier 2
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier2Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="currentTier2Limit"
                                  placeholder="10,000"
                                  disabled
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier2Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="currentTier2Rate"
                                  placeholder="3.75"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Tier 3 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="currentTier3Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-danger"
                                  for="currentTier3Enabled"
                                >
                                  Tier 3
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier3Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="currentTier3Limit"
                                  placeholder="20,000"
                                  disabled
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier3Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="currentTier3Rate"
                                  placeholder="6.25"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Tier 4 -->
                      <div class="card mb-2">
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="currentTier4Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-dark"
                                  for="currentTier4Enabled"
                                >
                                  Tier 4
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier4Limit"
                                  class="form-label small"
                                  hidden
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="currentTier4Limit"
                                  placeholder="0"
                                  disabled
                                  hidden
                                />
                                <small class="text-muted">No usage limit</small>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="currentTier4Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="currentTier4Rate"
                                  placeholder="10.00"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-6">
                <!-- What-if/Future Rate Structure -->
                <div class="card mb-2">
                  <div
                    class="card-header bg-light d-flex justify-content-between align-items-center"
                    data-bs-toggle="collapse"
                    data-bs-target="#futureRateCollapse"
                    aria-expanded="true"
                  >
                    <h3 class="card-title">
                      <i class="bi bi-lightbulb me-2"></i>Future/What-If Rate
                      Structure
                    </h3>
                    <i class="bi bi-chevron-down toggle-icon"></i>
                  </div>
                  <div class="collapse show" id="futureRateCollapse">
                    <div class="card-body">
                      <!-- Fixed Charges -->
                      <div class="bg-light p-3 rounded mb-4">
                        <h5 class="text-primary mb-3">
                          <i class="bi bi-currency-dollar me-2"></i>Fixed
                          Monthly Charges
                        </h5>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="futureBaseRate" class="form-label"
                                >Base Rate ($)</label
                              >
                              <input
                                type="number"
                                class="form-control"
                                id="futureBaseRate"
                                placeholder="0.00"
                                step="0.01"
                              />
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="futureAddonFee" class="form-label"
                                >Add-on Fee ($)</label
                              >
                              <input
                                type="number"
                                class="form-control"
                                id="futureAddonFee"
                                placeholder="0.00"
                                step="0.01"
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Tier Structure -->
                      <h5 class="text-primary mb-3">
                        <i class="bi bi-bar-chart-steps me-2"></i>Tiered Usage
                        Rates
                      </h5>

                      <!-- Future Tier 1 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="futureTier1Enabled"
                                  checked
                                />
                                <label
                                  class="form-check-label fw-bold text-primary"
                                  for="futureTier1Enabled"
                                >
                                  Tier 1
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier1Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="futureTier1Limit"
                                  placeholder="5,000"
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier1Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="futureTier1Rate"
                                  placeholder="2.50"
                                  step="0.01"
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Future Tier 2 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="futureTier2Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-warning"
                                  for="futureTier2Enabled"
                                >
                                  Tier 2
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier2Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="futureTier2Limit"
                                  placeholder="10,000"
                                  disabled
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier2Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="futureTier2Rate"
                                  placeholder="3.75"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Future Tier 3 -->
                      <div
                        class="card mb-2"
                      >
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="futureTier3Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-danger"
                                  for="futureTier3Enabled"
                                >
                                  Tier 3
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier3Limit"
                                  class="form-label small"
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="futureTier3Limit"
                                  placeholder="20,000"
                                  disabled
                                />
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier3Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="futureTier3Rate"
                                  placeholder="6.25"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Future Tier 4 -->
                      <div class="card mb-2">
                        <div class="card-body py-3">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input tier-enabled"
                                  type="checkbox"
                                  id="futureTier4Enabled"
                                />
                                <label
                                  class="form-check-label fw-bold text-dark"
                                  for="futureTier4Enabled"
                                >
                                  Tier 4
                                </label>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier4Limit"
                                  class="form-label small"
                                  hidden
                                  >Usage Limit (gallons)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-limit"
                                  id="futureTier4Limit"
                                  placeholder="0"
                                  disabled
                                  hidden
                                />
                                <small class="text-muted">No usage limit</small>
                              </div>
                            </div>
                            <div class="col-md-5">
                              <div class="mb-3">
                                <label
                                  for="futureTier4Rate"
                                  class="form-label small"
                                  >Rate ($/1,000 gal)</label
                                >
                                <input
                                  type="number"
                                  class="form-control form-control-sm tier-rate"
                                  id="futureTier4Rate"
                                  placeholder="10.00"
                                  step="0.01"
                                  disabled
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid" id="results-section">
        <div
          class="bg-light p-3 d-flex justify-content-between align-items-center border-bottom"
        >
          <h3 class="mb-0">
            <!-- Change mb-3 to mb-0 -->
            <i class="bi bi-graph-up me-2"></i>What-If Comparison Results
          </h3>
        </div>
        <div class="analysis-grid-container">
          <div class="card mb-2">
            <div class="card-header bg-light">
              <h3 class="card-title mb-0">
                Current Tier Structure Analysis (Year 0)
              </h3>
            </div>
            <div class="card-body">
<!-- Current Monthly Estimated Bill Breakdown -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-receipt me-2"></i>Monthly Estimated Bill Breakdown
  </h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Tier</th>
          <th>Gallons</th>
          <th>Rate ($/1,000 gal)</th>
          <th>Cost ($)</th>
        </tr>
      </thead>
      <tbody id="currentBillBreakdown"></tbody>
      <tfoot class="table-light">
        <tr>
          <th colspan="3" class="text-end border-top-2">Base Rate</th>
          <td id="currentBaseRateCost" class="fw-bold border-top-2">$0.00</td>
        </tr>
        <tr>
          <th colspan="3" class="text-end">Add-on Fee</th>
          <td id="currentAddonFeeCost" class="fw-bold">$0.00</td>
        </tr>
        <tr class="table-primary">
          <th colspan="3" class="text-end fw-bold">Total Monthly Bill</th>
          <td id="currentTotalBill" class="fw-bold fs-5">$0.00</td>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="mt-2">
    <small class="text-muted">
      <i class="bi bi-info-circle me-1"></i>
      Based on average monthly usage for your community.
    </small>
  </div>
</div>

<!-- Current Affordability Analysis Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-shield-check me-2"></i>Affordability Analysis
  </h5>
  <p class="mb-2">
    <strong>Monthly bill as percentage of Median Household Income:</strong>
    <span id="currentAffordabilityMHI" class="fw-bold text-primary">0.00%</span>
  </p>
  <div class="progress mb-3" style="height: 20px;">
    <div
      id="currentAffordabilityBar"
      class="progress-bar"
      role="progressbar"
      style="width: 0%"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
    ></div>
  </div>
  <div class="d-flex justify-content-between small">
    <span class="text-muted">0%</span>
    <span class="text-danger fw-bold">EPA Threshold: 2.5%</span>
    <span class="text-muted">10%</span>
  </div>
</div>
              <div class="row mb-4">
                <div class="col-12">
                  <div class="chart-container">
                    <canvas id="currentRevenuePieChart"></canvas>
                  </div>
                </div>
              </div>

<!-- Current Revenue Status Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-graph-up me-2"></i>Revenue Status
  </h5>
  <div class="row mb-3">
    <div class="col-md-6">
      <p class="mb-2">
        <strong>Annual Revenue:</strong>
        <span id="currentAnnualRevenue" class="text-success fw-bold">$0</span>
      </p>
      <p class="mb-2">
        <strong>Annual Revenue Need:</strong>
        <span id="currentAnnualRevenueNeed" class="text-primary fw-bold">$0</span>
      </p>
      <p class="mb-3">
        <strong>Revenue Gap:</strong>
        <span id="currentRevenueGap" class="fw-bold">$0</span>
      </p>
    </div>
    <div class="col-md-6">
      <div class="progress mb-3" style="height: 20px;">
        <div
          id="currentRevenueBar"
          class="progress-bar"
          role="progressbar"
          style="width: 0%"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
      <p class="text-center">
        Revenue meets <span id="currentRevenuePercentage" class="fw-bold">0%</span> of needs
      </p>
    </div>
  </div>
  
  <!-- Financial Planning Factors Table -->
  <div class="border rounded p-3 bg-white">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-table me-2"></i>Financial Planning Factors
    </h6>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <tbody>
          <tr>
            <th class="border-0 bg-transparent">Operating Costs:</th>
            <td class="border-0 bg-transparent" id="currentOperatingCost">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Debt Service:</th>
            <td class="border-0 bg-transparent" id="currentDebtService">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Infrastructure Reserve:</th>
            <td class="border-0 bg-transparent" id="currentInfrastructureReserve">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Current Year Grants:</th>
            <td class="border-0 bg-transparent" id="currentYearGrants">$0.00</td>
          </tr>
          <tr class="table-primary">
            <th class="fw-bold">Net Annual Revenue Need:</th>
            <td class="fw-bold" id="currentNetRevenueNeed">$0.00</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Current Water Loss & Poverty Impact Analysis section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-exclamation-triangle me-2"></i>Impact Analysis
  </h5>
  <div class="row">
    <div class="col-md-6">
      <div class="border rounded p-3 bg-white mb-3 mb-md-0">
        <h6 class="text-secondary mb-3">
          <i class="bi bi-people me-2"></i>Poverty Level Affordability
        </h6>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <tbody>
              <tr>
                <th class="border-0 bg-transparent">Bill at Average Usage:</th>
                <td class="border-0 bg-transparent" id="currentAvgBill">$0.00</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">% of Poverty Income:</th>
                <td class="border-0 bg-transparent" id="currentPovertyPercent">0.00%</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">Status:</th>
                <td class="border-0 bg-transparent">
                  <span id="currentPovertyStatus" class="badge bg-secondary">Unknown</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="border rounded p-3 bg-white">
        <h6 class="text-secondary mb-3">
          <i class="bi bi-droplet-half me-2"></i>Water Loss Impact
        </h6>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <tbody>
              <tr>
                <th class="border-0 bg-transparent">Lost Water Volume:</th>
                <td class="border-0 bg-transparent" id="currentWaterLossVolume">0</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">Financial Impact:</th>
                <td class="border-0 bg-transparent" id="currentWaterLossFinancial">$0.00</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">% of Annual Revenue:</th>
                <td class="border-0 bg-transparent" id="currentWaterLossPercent">0%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Current Bill Comparison Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-table me-2"></i>Bill Comparison at Different Usage Levels
  </h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Usage (gallons/month)</th>
          <th>Monthly Bill ($)</th>
          <th>Affordability (% of MHI)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="currentBillComparison"></tbody>
    </table>
  </div>
  <div class="mt-2">
    <small class="text-muted">
      <i class="bi bi-info-circle me-1"></i>
      This table shows how bills vary across different usage levels under the current rate structure.
    </small>
  </div>
</div>
            </div>
          </div>

          <div class="card mb-2">
            <div class="card-header bg-light">
              <h3 class="card-title mb-0">
                <span class="badge bg-info">What-If Scenario</span>

                Tier Structure Analysis (Year 1)
              </h3>
            </div>
            <div class="card-body">
<!-- Future Monthly Estimated Bill Breakdown -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-receipt me-2"></i>Monthly Estimated Bill Breakdown
  </h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Tier</th>
          <th>Gallons</th>
          <th>Rate ($/1,000 gal)</th>
          <th>Cost ($)</th>
        </tr>
      </thead>
      <tbody id="futureBillBreakdown"></tbody>
      <tfoot class="table-light">
        <tr>
          <th colspan="3" class="text-end border-top-2">Base Rate</th>
          <td id="futureBaseRateCost" class="fw-bold border-top-2">$0.00</td>
        </tr>
        <tr>
          <th colspan="3" class="text-end">Add-on Fee</th>
          <td id="futureAddonFeeCost" class="fw-bold">$0.00</td>
        </tr>
        <tr class="table-primary">
          <th colspan="3" class="text-end fw-bold">Total Monthly Bill</th>
          <td id="futureTotalBill" class="fw-bold fs-5">$0.00</td>
        </tr>
      </tfoot>
    </table>
  </div>
  <div class="mt-2">
    <small class="text-muted">
      <i class="bi bi-info-circle me-1"></i>
      Based on average monthly usage under the what-if rate structure.
    </small>
  </div>
</div>

<!-- Future Affordability Analysis Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-shield-check me-2"></i>Affordability Analysis
  </h5>
  <p class="mb-2">
    <strong>Monthly bill as percentage of Median Household Income:</strong>
    <span id="futureAffordabilityMHI" class="fw-bold text-primary">0.00%</span>
  </p>
  <div class="progress mb-3" style="height: 20px;">
    <div
      id="futureAffordabilityBar"
      class="progress-bar"
      role="progressbar"
      style="width: 0%"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
    ></div>
  </div>
  <div class="d-flex justify-content-between small">
    <span class="text-muted">0%</span>
    <span class="text-danger fw-bold">EPA Threshold: 2.5%</span>
    <span class="text-muted">10%</span>
  </div>
</div>
              <div class="row mb-4">
                <div class="col-12">
                  <div class="chart-container">
                    <canvas id="futureRevenuePieChart"></canvas>
                  </div>
                </div>
              </div>

<!-- Future Revenue Status Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-graph-up me-2"></i>Revenue Status
  </h5>
  <div class="row mb-3">
    <div class="col-md-6">
      <p class="mb-2">
        <strong>Annual Revenue:</strong>
        <span id="futureAnnualRevenue" class="text-success fw-bold">$0</span>
      </p>
      <p class="mb-2">
        <strong>Annual Revenue Need:</strong>
        <span id="futureAnnualRevenueNeed" class="text-primary fw-bold">$0</span>
      </p>
      <p class="mb-3">
        <strong>Revenue Gap:</strong>
        <span id="futureRevenueGap" class="fw-bold">$0</span>
      </p>
    </div>
    <div class="col-md-6">
      <div class="progress mb-3" style="height: 20px;">
        <div
          id="futureRevenueBar"
          class="progress-bar"
          role="progressbar"
          style="width: 0%"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
      <p class="text-center">
        Revenue meets <span id="futureRevenuePercentage" class="fw-bold">0%</span> of needs
      </p>
    </div>
  </div>
  
  <!-- Financial Planning Factors Table -->
  <div class="border rounded p-3 bg-white">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-table me-2"></i>Financial Planning Factors
    </h6>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <tbody>
          <tr>
            <th class="border-0 bg-transparent">Operating Costs:</th>
            <td class="border-0 bg-transparent" id="futureOperatingCost">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Debt Service:</th>
            <td class="border-0 bg-transparent" id="futureDebtService">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Infrastructure Reserve:</th>
            <td class="border-0 bg-transparent" id="futureInfrastructureReserve">$0.00</td>
          </tr>
          <tr>
            <th class="border-0 bg-transparent">Year 1 Grants:</th>
            <td class="border-0 bg-transparent" id="futureGrantFunding">$0.00</td>
          </tr>
          <tr class="table-primary">
            <th class="fw-bold">Net Annual Revenue Need:</th>
            <td class="fw-bold" id="futureNetRevenueNeed">$0.00</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>              

<!-- Future Water Loss & Poverty Impact Analysis section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-exclamation-triangle me-2"></i>Impact Analysis
  </h5>
  <div class="row">
    <div class="col-md-6">
      <div class="border rounded p-3 bg-white mb-3 mb-md-0">
        <h6 class="text-secondary mb-3">
          <i class="bi bi-people me-2"></i>Poverty Level Affordability
        </h6>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <tbody>
              <tr>
                <th class="border-0 bg-transparent">Bill at Average Usage:</th>
                <td class="border-0 bg-transparent" id="futureAvgBill">$0.00</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">% of Poverty Income:</th>
                <td class="border-0 bg-transparent" id="futurePovertyPercent">0.00%</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">Status:</th>
                <td class="border-0 bg-transparent">
                  <span id="futurePovertyStatus" class="badge bg-secondary">Unknown</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="border rounded p-3 bg-white">
        <h6 class="text-secondary mb-3">
          <i class="bi bi-droplet-half me-2"></i>Water Loss Impact
        </h6>
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <tbody>
              <tr>
                <th class="border-0 bg-transparent">Lost Water Volume:</th>
                <td class="border-0 bg-transparent" id="futureWaterLossVolume">0</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">Financial Impact:</th>
                <td class="border-0 bg-transparent" id="futureWaterLossFinancial">$0.00</td>
              </tr>
              <tr>
                <th class="border-0 bg-transparent">% of Annual Revenue:</th>
                <td class="border-0 bg-transparent" id="futureWaterLossPercent">0%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Future Bill Comparison Section -->
<div class="bg-light rounded p-3 mb-4">
  <h5 class="text-primary mb-3">
    <i class="bi bi-table me-2"></i>Bill Comparison at Different Usage Levels
  </h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Usage (gallons/month)</th>
          <th>Monthly Bill ($)</th>
          <th>Affordability (% of MHI)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="futureBillComparison"></tbody>
    </table>
  </div>
  <div class="mt-2">
    <small class="text-muted">
      <i class="bi bi-info-circle me-1"></i>
      This table shows how bills vary across different usage levels under the what-if rate structure.
    </small>
  </div>
</div>
            </div>
          </div>
        </div>
        <div class="p-3">
          <!-- Bill Impact by Usage Level Chart -->
          <div class="card mb-4">
            <div class="card-header bg-light d-flex align-items-center">
              <h3 class="card-title mb-0">Bill Impact by Usage Level</h3>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="billImpactChart" height="300"></canvas>
              </div>
              <div class="chart-description">
                This chart shows how the proposed rate structure affects bills
                for different levels of usage compared to current rates.
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <!-- Current Revenue Composition Level Chart -->
              <div class="card mb-2">
                <div class="card-header bg-light">
                  <h3 class="card-title mb-0">Current Revenue Composition</h3>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="currentRevenueCompositionChart"></canvas>
                  </div>
                  <div class="chart-description mt-2">
                    <p>
                      Breakdown of fixed vs. variable revenue in current rate
                      structure.
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <!-- What-If Revenue Composition Level Chart -->
              <div class="card mb-2">
                <div class="card-header bg-light">
                  <h3 class="card-title mb-0">What-If Revenue Composition</h3>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="futureRevenueCompositionChart"></canvas>
                  </div>
                  <div class="chart-description mt-2">
                    <p>
                      Breakdown of fixed vs. variable revenue in what-if rate
                      structure.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Financial Health & Affordability Comparison -->
          <div class="card mb-2">
            <div class="card-header bg-light">
              <h3 class="card-title mb-0">
                Financial Health & Affordability Comparison (Current vs.
                What-If)
              </h3>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Key Metric</th>
                      <th>Current Structure</th>
                      <th>What-If Structure</th>
                      <th>Difference</th>
                      <th>Impact</th>
                    </tr>
                  </thead>
                  <tbody id="keyMetricsComparisonTable">
                    <!-- Will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
              <div class="chart-description">
                This table highlights key financial and affordability metrics
                for both rate structures, showing the impact of your proposed
                changes.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid" id="financialAdvisorContainer">
        <div
          class="bg-light p-3 d-flex justify-content-between align-items-center border-bottom"
        >
          <h3 class="mb-0">
            <!-- Change mb-3 to mb-0 -->
            <i class="bi bi-graph-up-arrow me-2"></i>Financial Advisor
          </h3>
        </div>
        <div class="card-body">
          <div id="recommendationsSection" class="d-none">
            <div class="card mb-2" id="recommendationsCard">
              <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                  Recommended Rate Implementation Plan
                </h4>
              </div>
              <div class="card-body" id="recommendationsCardBody"></div>
            </div>
            <div class="card mb-2 border-0 shadow-sm">
              <div
                class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  <i class="bi bi-gear-fill me-2"></i>Rate Recommendation
                  Settings
                </h5>
                <button
                  class="btn btn-sm btn-outline-light"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#settingsCollapse"
                  aria-expanded="false"
                  aria-controls="settingsCollapse"
                >
                  <i class="bi bi-chevron-down me-1"></i>Show/Hide
                </button>
              </div>
              <div class="collapse" id="settingsCollapse">
                <div class="card-body">
                  <!-- Core Settings Section -->
                  <div class="bg-light rounded p-3 mb-4">
                    <h6 class="text-primary mb-3">
                      <i class="bi bi-sliders me-2"></i>Core Settings
                    </h6>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label
                          for="epaThreshold"
                          class="form-label fw-semibold"
                        >
                          <i class="bi bi-shield-check me-1 text-success"></i>
                          Affordability Threshold (% of MHI)
                        </label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="epaThreshold"
                            min="0.1"
                            max="10"
                            step="0.1"
                            value="2.5"
                            title="Maximum percentage of Median Household Income (MHI) an average water bill should be to be considered affordable. EPA guidance is typically 2.5%."
                          />
                          <span class="input-group-text bg-success text-white"
                            >%</span
                          >
                        </div>
                        <small class="form-text text-muted">
                          <i class="bi bi-info-circle me-1"></i>EPA guidance
                          suggests 2.5% of MHI
                        </small>
                      </div>
                      <div class="col-md-6">
                        <label
                          for="maxAnnualIncrease"
                          class="form-label fw-semibold"
                        >
                          <i class="bi bi-graph-up-arrow me-1 text-warning"></i>
                          Maximum Annual Rate Increase
                        </label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="maxAnnualIncrease"
                            min="1"
                            max="50"
                            step="1"
                            value="12"
                            title="The highest percentage any single rate component (base, add-on, or tier rate) can increase per year during the transition to optimal rates. Helps prevent rate shock."
                          />
                          <span class="input-group-text bg-warning text-white"
                            >%</span
                          >
                        </div>
                        <small class="form-text text-muted">
                          <i class="bi bi-exclamation-triangle me-1"></i
                          >Prevents rate shock
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- Revenue Distribution Section -->
                  <div class="bg-light rounded p-3 mb-4">
                    <h6 class="text-primary mb-3">
                      <i class="bi bi-pie-chart me-2"></i>Revenue Distribution
                    </h6>
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label
                          for="baseRatePercent"
                          class="form-label fw-semibold"
                        >
                          <i class="bi bi-house-fill me-1 text-primary"></i>Base
                          Rate
                        </label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="baseRatePercent"
                            min="0"
                            max="100"
                            step="1"
                            value="30"
                            title="Target percentage of total revenue from the fixed monthly base rate. Higher fixed charges provide more stable revenue."
                          />
                          <span class="input-group-text bg-primary text-white"
                            >%</span
                          >
                        </div>
                        <small class="form-text text-muted"
                          >Fixed monthly charge</small
                        >
                      </div>
                      <div class="col-md-4">
                        <label
                          for="addonFeePercent"
                          class="form-label fw-semibold"
                        >
                          <i class="bi bi-tools me-1 text-info"></i>Add-on Fee
                        </label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="addonFeePercent"
                            min="0"
                            max="100"
                            step="1"
                            value="20"
                            title="Target percentage of total revenue from a fixed monthly add-on fee (e.g., for infrastructure). Also contributes to revenue stability."
                          />
                          <span class="input-group-text bg-info text-white"
                            >%</span
                          >
                        </div>
                        <small class="form-text text-muted"
                          >Infrastructure fee</small
                        >
                      </div>
                      <div class="col-md-4">
                        <label
                          for="volumetricPercent"
                          class="form-label fw-semibold"
                        >
                          <i class="bi bi-droplet-fill me-1 text-success"></i
                          >Volumetric
                        </label>
                        <div class="input-group">
                          <input
                            type="number"
                            class="form-control"
                            id="volumetricPercent"
                            min="0"
                            max="100"
                            step="1"
                            value="50"
                            title="Target percentage of total revenue from charges based on actual water usage (volumetric rates). Promotes water conservation."
                          />
                          <span class="input-group-text bg-success text-white"
                            >%</span
                          >
                        </div>
                        <small class="form-text text-muted"
                          >Usage-based charges</small
                        >
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="alert alert-info py-2 mb-0">
                        <i class="bi bi-calculator me-2"></i>
                        <small class="form-text" id="percentTotal"
                          >Total: 100%</small
                        >
                      </div>
                    </div>
                  </div>

                  <!-- Tier Structure Section -->
                  <div class="bg-light rounded p-3 mb-4">
                    <h6 class="text-primary mb-3">
                      <i class="bi bi-bar-chart-steps me-2"></i>Tier Rate
                      Structure
                    </h6>

                    <!-- Tier Rate Multipliers -->
                    <div class="mb-4">
                      <h6 class="text-secondary mb-3">Rate Multipliers:</h6>
                      <div class="row mb-3">
                        <div class="col-md-3">
                          <label
                            for="tier1Multiplier"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-primary me-1">1</span>Tier 1
                          </label>
                          <input
                            type="number"
                            class="form-control"
                            id="tier1Multiplier"
                            value="1.0"
                            step="0.1"
                            disabled
                            title="Tier 1 rate is the base volumetric rate (multiplier of 1.0)."
                          />
                          <small class="form-text text-muted"
                            >Base rate (fixed)</small
                          >
                        </div>
                        <div class="col-md-3">
                          <label
                            for="tier2Multiplier"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-warning me-1">2</span>Tier 2
                          </label>
                          <input
                            type="number"
                            class="form-control"
                            id="tier2Multiplier"
                            min="1.1"
                            max="10"
                            value="1.5"
                            step="0.1"
                            title="Multiplier for Tier 2 volumetric rate (e.g., 1.5 means 1.5x the Tier 1 rate). Higher values encourage conservation."
                          />
                          <small class="form-text text-muted"
                            >Ã—1.5 base rate</small
                          >
                        </div>
                        <div class="col-md-3">
                          <label
                            for="tier3Multiplier"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-danger me-1">3</span>Tier 3
                          </label>
                          <input
                            type="number"
                            class="form-control"
                            id="tier3Multiplier"
                            min="1.1"
                            max="10"
                            value="2.5"
                            step="0.1"
                            title="Multiplier for Tier 3 volumetric rate."
                          />
                          <small class="form-text text-muted"
                            >Ã—2.5 base rate</small
                          >
                        </div>
                        <div class="col-md-3">
                          <label
                            for="tier4Multiplier"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-dark me-1">4</span>Tier 4
                          </label>
                          <input
                            type="number"
                            class="form-control"
                            id="tier4Multiplier"
                            min="1.1"
                            max="10"
                            value="4.0"
                            step="0.1"
                            title="Multiplier for Tier 4 (highest usage) volumetric rate."
                          />
                          <small class="form-text text-muted"
                            >Ã—4.0 base rate</small
                          >
                        </div>
                      </div>
                    </div>

                    <!-- Usage Limits -->
                    <div>
                      <h6 class="text-secondary mb-3">
                        Usage Limits (% of Average Usage):
                      </h6>
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <label
                            for="tier1LimitFactor"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-primary me-1">1</span>Tier 1
                            Limit
                          </label>
                          <div class="input-group">
                            <input
                              type="number"
                              class="form-control"
                              id="tier1LimitFactor"
                              min="10"
                              max="100"
                              step="5"
                              value="50"
                              title="Upper usage boundary for Tier 1, as a percentage of average monthly customer usage (e.g., 50% of average usage falls into Tier 1)."
                            />
                            <span class="input-group-text bg-primary text-white"
                              >%</span
                            >
                          </div>
                          <small class="form-text text-muted"
                            >0% to 50% of average</small
                          >
                        </div>
                        <div class="col-md-4">
                          <label
                            for="tier2LimitFactor"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-warning me-1">2</span>Tier 2
                            Limit
                          </label>
                          <div class="input-group">
                            <input
                              type="number"
                              class="form-control"
                              id="tier2LimitFactor"
                              min="50"
                              max="200"
                              step="5"
                              value="120"
                              title="Upper usage boundary for Tier 2, as a percentage of average monthly customer usage."
                            />
                            <span class="input-group-text bg-warning text-white"
                              >%</span
                            >
                          </div>
                          <small class="form-text text-muted"
                            >50% to 120% of average</small
                          >
                        </div>
                        <div class="col-md-4">
                          <label
                            for="tier3LimitFactor"
                            class="form-label fw-semibold"
                          >
                            <span class="badge bg-danger me-1">3</span>Tier 3
                            Limit
                          </label>
                          <div class="input-group">
                            <input
                              type="number"
                              class="form-control"
                              id="tier3LimitFactor"
                              min="100"
                              max="500"
                              step="5"
                              value="250"
                              title="Upper usage boundary for Tier 3, as a percentage of average monthly customer usage. Tier 4 applies to usage above this."
                            />
                            <span class="input-group-text bg-danger text-white"
                              >%</span
                            >
                          </div>
                          <small class="form-text text-muted"
                            >120% to 250% of average</small
                          >
                        </div>
                      </div>
                      <div class="alert alert-secondary py-2">
                        <i class="bi bi-info-circle me-2"></i>
                        <small
                          >Tier 4 applies to all usage above the Tier 3 limit
                          (250%+ of average usage)</small
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
<div class="card mb-2">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h4 class="card-title mb-0">
      Year-by-Year Financial Projection
    </h4>
    <!-- Replace tooltip button with collapsible toggle -->
    <button class="btn btn-outline-light btn-sm algorithm-overview-btn" 
            type="button"
            data-bs-toggle="collapse" 
            data-bs-target="#algorithmOverviewSection" 
            aria-expanded="false" 
            aria-controls="algorithmOverviewSection"
            id="algorithmOverviewToggle"
            style="display: none;">
      <i class="bi bi-info-circle me-1"></i>
      Algorithm Overview
      <i class="bi bi-chevron-down ms-1 toggle-chevron"></i>
    </button>
  </div>
  
  <!-- Add the collapsible algorithm overview section -->
  <div class="collapse" id="algorithmOverviewSection">
    <div class="card-body bg-light border-bottom">
      <div id="algorithmOverviewContent">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>
  
  <div class="card-body">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  This projection shows the recommended transition from current
                  rates to optimal rates over time, along with the financial
                  impact of capital projects, grants, and loans.
                </div>

                <div class="table-responsive">
                  <table
                    class="table table-bordered table-striped table-sm"
                    id="financialProjectionTable"
                  >
                    <thead class="table-light">
                      <tr>
                        <th rowspan="2">Year</th>
                        <th colspan="2">Fixed Charges</th>
                        <th colspan="7">Tier Structure</th>
                        <th colspan="3">Financial Planning</th>
                        <th colspan="3">Revenue</th>
                        <th rowspan="2">Reserve Balance</th>
                        <th rowspan="2">Debt Service</th>
                      </tr>
                      <tr>
                        <th>Base Rate</th>
                        <th>Add-on Fee</th>
                        <th>Tier 1 Rate</th>
                        <th>Limit</th>
                        <th>Tier 2 Rate</th>
                        <th>Limit</th>
                        <th>Tier 3 Rate</th>
                        <th>Limit</th>
                        <th>Tier 4 Rate</th>
                        <th>Capital Projects</th>
                        <th>Grants</th>
                        <th>New Loans</th>
                        <th>Expected</th>
                        <th>Needed</th>
                        <th>Gap</th>
                      </tr>
                    </thead>
                    <tbody id="projectionTableBody"></tbody>
                  </table>
                </div>

                <div class="mt-3">
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Year 0 represents current rates. Green values indicate
                    positive revenue gap or achieved reserve target.
                  </small>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-12 mb-4">
                <div class="card mb-0">
                  <div class="card-header">
                    <h5>Long-Term Financial Projections</h5>
                  </div>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas
                        id="financialProjectionsChart"
                        height="300"
                      ></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 mb-4">
                <div class="card mb-0">
                  <h5 class="card-header">Rate Structure Changes Over Time</h5>
                  <div class="card-body">
                    <div class="chart-container">
                      <canvas id="rateStructureChart" height="300"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 mb-4">
              <div class="card mb-0">
                <h5 class="card-header">
                  Poverty Level Affordability Analysis
                </h5>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas
                      id="affordabilityAnalysisChart"
                      height="300"
                    ></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 mb-4">
              <div class="card mb-0">
                <h5 class="card-header">Water Loss Financial Impact</h5>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="waterLossImpactChart" height="300"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- help modal -->
      <div
        class="modal fade"
        id="helpModal"
        tabindex="-1"
        aria-labelledby="helpModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="helpModalLabel">
                <i class="bi bi-question-circle me-2"></i>Water Pricing Calculator Help
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="accordion" id="helpAccordion">
                <!-- Tool Overview -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingOverview">
                    <button
                      class="accordion-button"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseOverview"
                      aria-expanded="true"
                      aria-controls="collapseOverview"
                    >
                      <i class="bi bi-info-circle me-2"></i> Tool Overview
                    </button>
                  </h2>
                  <div
                    id="collapseOverview"
                    class="accordion-collapse collapse show"
                    aria-labelledby="headingOverview"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <p>
                        The Oka' Institute Water Pricing Calculator is a comprehensive tool designed to help rural
                        and tribal water utilities develop sustainable, affordable water rate structures through:
                      </p>
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">Financial Planning</h6>
                          <ul>
                            <li><strong>Full-cost recovery</strong> analysis for O&M, debt, and infrastructure</li>
                            <li><strong>Multi-year projections</strong> with growth and inflation factors</li>
                            <li><strong>Debt service tracking</strong> for existing and planned loans</li>
                            <li><strong>Capital project planning</strong> with funding scenarios</li>
                          </ul>
                        </div>
                        <div class="col-md-6">
                          <h6 class="text-primary">Affordability & Compliance</h6>
                          <ul>
                            <li><strong>EPA affordability guidelines</strong> (2.5% of MHI threshold)</li>
                            <li><strong>Poverty-level impact</strong> analysis</li>
                            <li><strong>Rate optimization</strong> recommendations</li>
                            <li><strong>Conservation incentives</strong> through tiered pricing</li>
                          </ul>
                        </div>
                      </div>
                      <div class="alert alert-info mt-3">
                        <i class="bi bi-shield-check me-2"></i>
                        <strong>Privacy:</strong> All calculations run locally in your browser - no data is stored on any server.
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Getting Started -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingGettingStarted">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseGettingStarted"
                      aria-expanded="false"
                      aria-controls="collapseGettingStarted"
                    >
                      <i class="bi bi-play-circle me-2"></i> Getting Started
                    </button>
                  </h2>
                  <div
                    id="collapseGettingStarted"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingGettingStarted"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <h6>Quick Start Guide</h6>
                      <ol>
                        <li>
                          <strong>Choose a sample scenario:</strong> Select from the dropdown menu (Madill, Tuttle, Newcastle, or Ardmore) 
                          that most closely matches your community size
                        </li>
                        <li>
                          <strong>Customize inputs:</strong> Adjust values in each section to match your specific situation:
                          <ul class="mt-2">
                            <li>Community demographics and income data</li>
                            <li>Current system information and usage patterns</li>
                            <li>Financial parameters and existing debt</li>
                            <li>Current and proposed rate structures</li>
                          </ul>
                        </li>
                        <li>
                          <strong>Review results:</strong> Scroll to see automatic calculations including affordability analysis, 
                          revenue projections, and bill comparisons
                        </li>
                        <li>
                          <strong>Use Financial Advisor:</strong> Get optimal rate recommendations and implementation planning
                        </li>
                      </ol>
                      
                      <div class="alert alert-success mt-3">
                        <h6><i class="bi bi-lightbulb me-2"></i>Pro Tips</h6>
                        <ul class="mb-0">
                          <li>Use <kbd>Export</kbd> to save your work and <kbd>Import</kbd> to reload it later</li>
                          <li>Try the <kbd>Show Math</kbd> feature to see detailed calculation explanations</li>
                          <li>Collapse input sections using the toggle button for easier navigation</li>
                          <li>Use the Financial Advisor's "Apply to What-If Scenario" feature to copy recommended rates</li>                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Input Sections Guide -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingInputs">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseInputs"
                      aria-expanded="false"
                      aria-controls="collapseInputs"
                    >
                      <i class="bi bi-sliders2-vertical me-2"></i> Input Sections Guide
                    </button>
                  </h2>
                  <div
                    id="collapseInputs"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingInputs"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">Basic Information</h6>
                          <dl>
                            <dt><i class="bi bi-geo-alt me-1"></i>Community Information</dt>
                            <dd>Population, median household income, and poverty-level income for affordability calculations</dd>
                            
                            <dt><i class="bi bi-droplet me-1"></i>System Information</dt>
                            <dd>Customer count, average usage patterns, and system water loss percentage</dd>
                            
                            <dt><i class="bi bi-currency-dollar me-1"></i>Financial Information</dt>
                            <dd>Operating costs, existing debt payments, infrastructure replacement costs, and projection settings</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Financial Planning</h6>
                          <dl>
                            <dt><i class="bi bi-credit-card me-1"></i>Loans and Debt</dt>
                            <dd>Add existing loans or plan new borrowing with customizable terms and timing</dd>
                            
                            <dt><i class="bi bi-building me-1"></i>Capital Projects</dt>
                            <dd>Infrastructure investments with funding source options (loans, grants, or reserves)</dd>
                            
                            <dt><i class="bi bi-gift me-1"></i>Grants</dt>
                            <dd>External funding assistance that reduces revenue requirements</dd>
                          </dl>
                        </div>
                        
                        <div class="col-md-6">
                          <h6 class="text-primary">Rate Structures</h6>
                          <dl>
                            <dt><i class="bi bi-calculator me-1"></i>Current Rate Structure</dt>
                            <dd>Your existing water rates including base rate, add-on fees, and up to 4 usage tiers</dd>
                            
                            <dt><i class="bi bi-graph-up me-1"></i>What-If Rate Structure</dt>
                            <dd>Proposed rate changes for comparison and impact analysis</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Advanced Features</h6>
                          <dl>
                            <dt><i class="bi bi-robot me-1"></i>Financial Advisor Settings</dt>
                            <dd>Configure rate optimization parameters including affordability targets, revenue distribution, and annual increase limits</dd>
                            
                            <dt><i class="bi bi-sliders me-1"></i>Interactive Sliders</dt>
                            <dd>Many inputs can be converted to visual sliders for easier adjustment</dd>
                          </dl>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Results Explained -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingResults">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseResults"
                      aria-expanded="false"
                      aria-controls="collapseResults"
                    >
                      <i class="bi bi-graph-up me-2"></i> Understanding Results
                    </button>
                  </h2>
                  <div
                    id="collapseResults"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingResults"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">What-If Comparison Results</h6>
                          <ul>
                            <li><strong>Bill Breakdowns:</strong> Detailed tier-by-tier cost calculations for average usage</li>
                            <li><strong>Affordability Analysis:</strong> MHI percentage with EPA threshold comparison (2.5%)</li>
                            <li><strong>Revenue Analysis:</strong> Annual revenue vs. needs with coverage percentage</li>
                            <li><strong>Usage-Level Comparisons:</strong> Bill impacts across different consumption levels</li>
                            <li><strong>Poverty-Level Impact:</strong> Affordability for lowest-income residents</li>
                            <li><strong>Water Loss Impact:</strong> Revenue lost to system leaks and inefficiencies</li>
                          </ul>
                        </div>
                        
                        <div class="col-md-6">
                          <h6 class="text-primary">Financial Advisor Results</h6>
                          <ul>
                            <li><strong>Optimal Rate Structure:</strong> Algorithm-generated recommendations for sustainable rates</li>
                            <li><strong>Implementation Plan:</strong> Year-by-year transition strategy with gradual increases</li>
                            <li><strong>Financial Projections:</strong> Multi-year forecasts including reserves and debt service</li>
                            <li><strong>Affordability Compliance:</strong> Rate adjustments to maintain EPA guidelines</li>
                            <li><strong>Revenue Targeting:</strong> Precise rate calculations to meet financial needs</li>
                          </ul>
      
                          <h6 class="text-primary mt-4">Interactive Charts</h6>
                          <ul>
                            <li><strong>Bill Impact Analysis:</strong> Visual comparison of rate changes by usage level</li>
                            <li><strong>Revenue Composition:</strong> Breakdown of income sources (base, tiers, fees)</li>
                            <li><strong>Financial Projections:</strong> Long-term trends in revenues, reserves, and debt</li>
                            <li><strong>Affordability Tracking:</strong> MHI percentage trends over projection period</li>
                          </ul>
                        </div>
                      </div>
                      
                      <div class="alert alert-warning mt-3">
                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Status Indicators</h6>
                        <ul class="mb-0">
                          <li><span class="badge bg-success">Green</span> indicates good/affordable status</li>
                          <li><span class="badge bg-warning">Yellow</span> shows moderate concern areas</li>
                          <li><span class="badge bg-danger">Red</span> highlights issues requiring attention</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Tool Functions -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingFunctions">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseFunctions"
                      aria-expanded="false"
                      aria-controls="collapseFunctions"
                    >
                      <i class="bi bi-tools me-2"></i> Tool Functions & Features
                    </button>
                  </h2>
                  <div
                    id="collapseFunctions"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingFunctions"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">Navigation & Display</h6>
                          <dl>
                            <dt><i class="bi bi-arrows-collapse text-primary"></i> Collapse Inputs</dt>
                            <dd>Toggle all input sections open/closed for easier navigation of long forms</dd>
      
                            <dt><i class="bi bi-calculator text-info"></i> Show Math</dt>
                            <dd>Display detailed calculation explanations and formulas behind every result for audit purposes</dd>
      
                            <dt><i class="bi bi-eye text-secondary"></i> Collapsible Tables</dt>
                            <dd>Hide/show detailed data tables to reduce visual clutter while keeping information accessible</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Data Management</h6>
                          <dl>
                            <dt><i class="bi bi-download text-success"></i> Export Data</dt>
                            <dd>Save complete analysis to CSV file including all inputs, settings, and calculated results</dd>
      
                            <dt><i class="bi bi-upload text-warning"></i> Import Data</dt>
                            <dd>Load previously saved analysis from CSV file to continue work or share scenarios</dd>
                          </dl>
                        </div>
      
                        <div class="col-md-6">
                          <h6 class="text-primary">Financial Advisor Tools</h6>
                          <dl>
                            <dt><i class="bi bi-robot text-primary"></i> Generate Recommendations</dt>
                            <dd>Algorithm-powered rate optimization considering affordability, revenue needs, and implementation constraints</dd>
      
                            <dt><i class="bi bi-copy text-info"></i> Apply to What-If Scenario</dt>
                            <dd>Apply recommended rates directly to What-If scenario for immediate testing and comparison. This button appears in the Financial Advisor section after recommendations are generated.</dd>      
                            <dt><i class="bi bi-graph-up-arrow text-success"></i> Implementation Planning</dt>
                            <dd>Multi-year transition strategy with annual rate increases respecting affordability limits</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Scenario Management</h6>
                          <dl>
                            <dt><i class="bi bi-collection text-secondary"></i> Sample Scenarios</dt>
                            <dd>Pre-configured examples for Oklahoma communities of different sizes (Madill, Tuttle, Newcastle, Ardmore)</dd>
      
                            <dt><i class="bi bi-arrow-up-circle text-primary"></i> Back to Top</dt>
                            <dd>Quick navigation button appears when scrolling to return to input sections</dd>
                          </dl>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Key Concepts -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingKeyConcepts">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseKeyConcepts"
                      aria-expanded="false"
                      aria-controls="collapseKeyConcepts"
                    >
                      <i class="bi bi-lightbulb me-2"></i> Key Concepts & Terminology
                    </button>
                  </h2>
                  <div
                    id="collapseKeyConcepts"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingKeyConcepts"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">Financial Concepts</h6>
                          <dl>
                            <dt>Full-Cost Recovery</dt>
                            <dd>Setting rates that cover all costs to operate, maintain, and eventually replace your water system infrastructure</dd>
      
                            <dt>O&M Costs</dt>
                            <dd>Operations and Maintenance costs - day-to-day expenses like staff salaries, chemicals, electricity, and routine repairs</dd>
      
                            <dt>Infrastructure Reserve</dt>
                            <dd>Annual funding set aside for major capital improvements and system replacement needs</dd>
      
                            <dt>Debt Service Coverage</dt>
                            <dd>The ratio of available revenue to required debt payments, indicating financial capacity to handle borrowing</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Rate Structure Terms</h6>
                          <dl>
                            <dt>Base Rate</dt>
                            <dd>Fixed monthly charge applied to all customers regardless of usage, providing revenue stability</dd>
      
                            <dt>Add-on Fee</dt>
                            <dd>Additional fixed monthly charge often used for infrastructure funding or specific purposes</dd>
      
                            <dt>Tiered Rate Structure</dt>
                            <dd>Usage-based billing system with different rates for different consumption levels, promoting conservation</dd>
      
                            <dt>Volumetric Charges</dt>
                            <dd>Variable costs based on actual water consumption, typically expressed per 1,000 gallons</dd>
                          </dl>
                        </div>
      
                        <div class="col-md-6">
                          <h6 class="text-primary">Affordability Measures</h6>
                          <dl>
                            <dt>MHI (Median Household Income)</dt>
                            <dd>The middle income value in your community - 50% of households earn more, 50% earn less</dd>
      
                            <dt>EPA Affordability Threshold</dt>
                            <dd>EPA guidance suggesting water bills should not exceed 2.5% of community MHI to remain affordable</dd>
      
                            <dt>Poverty-Level Impact</dt>
                            <dd>Analysis of how water bills affect households at federal poverty income levels</dd>
      
                            <dt>Burden Classification</dt>
                            <dd>
                              <ul class="small">
                                <li><strong>Affordable:</strong> &lt;1.5% of MHI</li>
                                <li><strong>Moderate:</strong> 1.5-2.5% of MHI</li>
                                <li><strong>High Burden:</strong> &gt;2.5% of MHI</li>
                              </ul>
                            </dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Planning Concepts</h6>
                          <dl>
                            <dt>Customer Growth</dt>
                            <dd>Projected annual increase in service connections affecting revenue and demand</dd>
      
                            <dt>Inflation Factor</dt>
                            <dd>Annual cost increase rate applied to operating expenses and construction costs</dd>
      
                            <dt>Water Loss Percentage</dt>
                            <dd>System inefficiency representing water produced but not billed, affecting revenue</dd>
      
                            <dt>Asset Lifespan</dt>
                            <dd>Expected useful life of infrastructure components for replacement planning and reserve calculations</dd>
                          </dl>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
      
                <!-- Troubleshooting -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTroubleshooting">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseTroubleshooting"
                      aria-expanded="false"
                      aria-controls="collapseTroubleshooting"
                    >
                      <i class="bi bi-question-circle me-2"></i> Troubleshooting & Tips
                    </button>
                  </h2>
                  <div
                    id="collapseTroubleshooting"
                    class="accordion-collapse collapse"
                    aria-labelledby="headingTroubleshooting"
                    data-bs-parent="#helpAccordion"
                  >
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-primary">Common Issues</h6>
                          <dl>
                            <dt class="text-danger">Red Revenue Status</dt>
                            <dd>
                              <strong>Problem:</strong> Rates don't generate enough revenue<br>
                              <strong>Solutions:</strong> Increase base rates, add-on fees, or tier rates; reduce expenses; seek grants
                            </dd>
      
                            <dt class="text-danger">High Affordability Burden</dt>
                            <dd>
                              <strong>Problem:</strong> Bills exceed EPA 2.5% threshold<br>
                              <strong>Solutions:</strong> Use Financial Advisor for balanced approach; consider phased rate increases; seek additional funding sources
                            </dd>
      
                            <dt class="text-warning">Missing Required Fields</dt>
                            <dd>
                              <strong>Problem:</strong> Calculations cannot complete<br>
                              <strong>Solution:</strong> Fill all required fields (highlighted in red) or use sample scenarios as starting points
                            </dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Best Practices</h6>
                          <ul>
                            <li>Start with sample scenarios closest to your situation</li>
                            <li>Validate your data against utility records</li>
                            <li>Use conservative estimates for growth and inflation</li>
                            <li>Plan for infrastructure replacement needs</li>
                            <li>Consider phased implementation of major rate changes</li>
                          </ul>
                        </div>
      
                        <div class="col-md-6">
                          <h6 class="text-primary">Optimization Strategies</h6>
                          <dl>
                            <dt>Revenue Stability</dt>
                            <dd>Balance fixed charges (base rate, add-on) with volumetric charges for predictable income</dd>
      
                            <dt>Conservation Incentives</dt>
                            <dd>Use increasing tier rates to encourage efficient water use while maintaining revenue</dd>
      
                            <dt>Affordability Management</dt>
                            <dd>Use Financial Advisor to automatically balance revenue needs with affordability constraints</dd>
      
                            <dt>Implementation Timing</dt>
                            <dd>Plan gradual rate increases to avoid rate shock while ensuring financial sustainability</dd>
                          </dl>
      
                          <h6 class="text-primary mt-4">Data Quality Tips</h6>
                          <ul>
                            <li>Use actual billing data for customer count and average usage</li>
                            <li>Verify income data with recent census or community surveys</li>
                            <li>Include all debt obligations and their terms</li>
                            <li>Account for planned capital improvements</li>
                            <li>Regular updates as conditions change</li>
                          </ul>
      
                          <div class="alert alert-info mt-3">
                            <h6><i class="bi bi-info-circle me-2"></i>Need More Help?</h6>
                            <p class="mb-0">
                              Contact the Oka' Institute for technical assistance with complex rate structure development 
                              or interpretation of results for your specific situation.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer bg-light">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
                id="helpModalCloseBtn"
              >
                <i class="bi bi-x-circle me-1"></i>Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
    <button
      id="backToTop"
      class="btn btn-light position-fixed rounded-circle shadow-sm border-0"
      style="
        bottom: 30px;
        right: 30px;
        width: 48px;
        height: 48px;
        display: none;
        z-index: 9999;
        opacity: 0.9;
        transition: all 0.3s ease;
      "
    >
      <i class="bi bi-arrow-up text-primary"></i>
    </button>
    <script src="js/math-explanations.js"></script>
    <script src="js/app.js"></script>
    <script src="js/inputs.js"></script>
    <script src="js/scenarios.js"></script>
    <script src="js/calculations.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/financial-planning.js"></script>
    <script src="js/collapsible-tables.js"></script>
    <script src="js/rate-recommendations.js"></script>
    <script src="js/slider-converter.js"></script>
    <script src="js/show-math.js"></script>
    <script src="js/export-import.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <div
      class="toast-container position-fixed bottom-0 end-0 p-3"
      style="z-index: 11"
    >
      <div
        id="scenarioToast"
        class="toast"
        role="alert"
        aria-live="polite"
        aria-atomic="true"
      >
        <div class="toast-header bg-success text-white">
          <i class="bi bi-check-circle-fill me-2"></i>
          <strong class="me-auto">Success</strong>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body" id="scenarioToastMessage">
          Scenario loaded successfully.
        </div>
      </div>
        <!-- New Math Mode toast -->
  <div
    id="mathModeToast"
    class="toast"
    role="alert"
    aria-live="polite"
    aria-atomic="true"
  >
    <div class="toast-header" id="mathModeToastHeader">
      <i id="mathModeToastIcon" class="bi bi-calculator me-2"></i>
      <strong class="me-auto">Math Mode</strong>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="toast"
        aria-label="Close"
      ></button>
    </div>
    <div class="toast-body" id="mathModeToastMessage">
      Math mode enabled. Calculation details are now visible.
    </div>
  </div>
    </div>
  </body>
</html>
